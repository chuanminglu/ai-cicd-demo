# 常见问题排查指南

## 🔍 GitHub Actions相关问题

### 问题1：上传覆盖率报告失败

**错误信息**：
```
Warning: No files were found with the provided path: .coverage. 
No artifacts will be uploaded.
```

**原因分析**：

1. `.coverage` 是pytest-cov生成的SQLite数据库文件，上传后无法直接查看
2. 该文件主要供coverage工具内部使用，对人类阅读不友好
3. 更好的选择是上传HTML格式的覆盖率报告

**解决方案**：

修改 `.github/workflows/quality-gate.yml`：

```yaml
# ❌ 错误方式：上传.coverage数据库文件
- name: 上传覆盖率报告
  uses: actions/upload-artifact@v4
  with:
    name: coverage-report
    path: .coverage

# ✅ 正确方式：上传HTML报告目录
- name: 上传HTML覆盖率报告
  uses: actions/upload-artifact@v4
  with:
    name: coverage-report
    path: htmlcov/
```

同时修改pytest命令，生成HTML报告：

```yaml
- name: Pytest单元测试与覆盖率
  run: |
    echo "🧪 执行单元测试并检查覆盖率..."
    pytest tests/ --cov=src --cov-report=term-missing --cov-report=html --cov-fail-under=80 -v
    echo "✅ 测试通过，覆盖率 >= 80%"
```

**验证修复**：

1. 提交修改并推送到GitHub
2. 查看Actions执行日志，应显示：
   ```
   ✅ Upload HTML coverage report (2s)
   ```
3. 在Artifacts区域应能看到 `coverage-report`
4. 下载解压后，打开 `index.html` 查看覆盖率

---

### 问题2：Actions执行失败 - Pylint评分过低

**错误信息**：
```
❌ Pylint code quality check
Your code has been rated at 7.5/10
```

**原因分析**：

代码质量评分低于设定的阈值（8.0）

**常见扣分原因**：

| 问题类型 | 扣分 | 示例 |
|---------|------|------|
| 缺少docstring | -0.5/函数 | 函数没有文档字符串 |
| 变量命名不规范 | -0.2/个 | `Var1` 应该是 `var_1` |
| 行过长 | -0.1/行 | 超过100字符 |
| 导入未使用 | -0.1/个 | `import os` 但没用到 |
| 函数过于复杂 | -1.0/个 | 圈复杂度过高 |

**解决方案**：

方式1：修复代码问题（推荐）
```bash
# 本地运行Pylint查看详细问题
python -m pylint src/ --output-format=text

# 根据提示修复代码
# - 添加docstring
# - 规范命名
# - 简化复杂函数
```

方式2：调整Pylint配置（慎用）

创建 `.pylintrc` 文件：
```ini
[MESSAGES CONTROL]
disable=missing-docstring,line-too-long

[FORMAT]
max-line-length=120
```

方式3：降低质量门阈值（不推荐）
```yaml
- name: Pylint代码质量检查
  run: |
    pylint src/ --fail-under=7.0  # 降低到7.0
```

---

### 问题3：Actions执行失败 - 测试覆盖率不足

**错误信息**：
```
❌ Pytest单元测试与覆盖率
FAILED: Required test coverage of 80% not reached. Total coverage: 65.00%
```

**原因分析**：

测试用例未覆盖足够的代码行

**排查步骤**：

1. **本地生成HTML覆盖率报告**：
   ```bash
   pytest tests/ --cov=src --cov-report=html
   start htmlcov/index.html  # Windows
   ```

2. **查看未覆盖的代码**：
   - 红色行：未被测试执行
   - 黄色行：部分分支未覆盖
   - 绿色行：已完全覆盖

3. **识别缺失的测试场景**：
   ```python
   # 示例：未覆盖的异常处理
   def calculate(price):
       if price < 0:
           raise ValueError("价格不能为负")  # ❌ 未测试
       return price * 0.8
   ```

**解决方案**：

补充测试用例：
```python
def test_negative_price_raises_error(self):
    """测试负价格抛出异常"""
    with self.assertRaises(ValueError):
        calculate(-100)  # ✅ 覆盖异常分支
```

---

### 问题4：Actions执行时间过长

**症状**：
```
⏱️ Pytest单元测试与覆盖率 (5m 32s)
```

**原因分析**：

- 测试用例执行缓慢
- 数据库操作未mock
- 网络请求未mock
- 测试数据量过大

**解决方案**：

1. **使用pytest-xdist并行执行**：
   ```yaml
   - name: 安装依赖
     run: |
       pip install pytest pytest-cov pytest-xdist pylint
   
   - name: Pytest单元测试
     run: |
       pytest tests/ -n auto --cov=src --cov-report=html -v
   ```

2. **Mock外部依赖**：
   ```python
   from unittest.mock import patch
   
   @patch('requests.get')
   def test_api_call(self, mock_get):
       mock_get.return_value.status_code = 200
       # 测试逻辑
   ```

3. **使用缓存加速依赖安装**：
   ```yaml
   - name: 设置Python
     uses: actions/setup-python@v4
     with:
       python-version: '3.9'
       cache: 'pip'  # 启用pip缓存
   
   - name: 安装依赖
     run: pip install -r requirements.txt
   ```

---

## 🐛 本地开发问题

### 问题5：pytest找不到模块

**错误信息**：
```
ModuleNotFoundError: No module named 'src'
```

**解决方案**：

方式1：创建 `__init__.py` 文件
```bash
touch src/__init__.py
touch tests/__init__.py
```

方式2：设置PYTHONPATH
```bash
# Linux/Mac
export PYTHONPATH=$PYTHONPATH:$(pwd)

# Windows PowerShell
$env:PYTHONPATH="$env:PYTHONPATH;$(pwd)"

# 然后运行pytest
pytest tests/ --cov=src
```

方式3：在测试文件中添加路径
```python
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from src.price_calculator import PriceCalculator
```

---

### 问题6：覆盖率报告中包含了测试代码

**症状**：
```
Name                          Stmts   Miss  Cover
-------------------------------------------------
src/price_calculator.py          10      0   100%
tests/test_calculator.py         25      0   100%  ❌ 不应该统计测试代码
-------------------------------------------------
TOTAL                            35      0   100%
```

**解决方案**：

创建 `.coveragerc` 配置文件：

```ini
[run]
source = src
omit = 
    */tests/*
    */test_*.py
    */__init__.py

[report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
```

或在 `pyproject.toml` 中配置：

```toml
[tool.coverage.run]
source = ["src"]
omit = ["*/tests/*", "*/test_*.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise NotImplementedError"
]
```

---

### 问题7：Pylint报告太多"missing-docstring"警告

**错误信息**：
```
C0111: Missing module docstring (missing-docstring)
C0111: Missing class docstring (missing-docstring)
C0111: Missing function docstring (missing-docstring)
```

**解决方案**：

方式1：添加docstring（推荐）
```python
"""
电商价格计算模块

提供价格计算相关功能。
"""

class PriceCalculator:
    """价格计算器类"""
    
    def calculate(self, price):
        """
        计算最终价格
        
        Args:
            price (float): 商品原价
            
        Returns:
            float: 最终价格
        """
        return price * 0.8
```

方式2：禁用特定规则
```python
# pylint: disable=missing-docstring
def helper_function():
    return True
```

方式3：在配置文件中禁用（不推荐）
```ini
# .pylintrc
[MESSAGES CONTROL]
disable=missing-docstring
```

---

## 📝 最佳实践

### 1. 提交前的检查清单

```bash
# 1. 格式化代码
black src/ tests/

# 2. 代码质量检查
pylint src/ --fail-under=8.0

# 3. 运行测试
pytest tests/ -v

# 4. 检查覆盖率
pytest tests/ --cov=src --cov-report=term-missing --cov-fail-under=80

# 5. 生成HTML报告（可选）
pytest tests/ --cov=src --cov-report=html

# 6. 提交代码
git add .
git commit -m "feat: add new feature"
git push
```

### 2. 本地质量门脚本

创建 `run_quality_check.sh`（Linux/Mac）或 `run_quality_check.bat`（Windows）：

```bash
#!/bin/bash
set -e

echo "🔍 开始质量门检查..."

echo "步骤1: Pylint检查..."
python -m pylint src/ --fail-under=8.0

echo "步骤2: 运行测试..."
python -m pytest tests/ --cov=src --cov-report=html --cov-report=term-missing --cov-fail-under=80 -v

echo "✅ 所有检查通过！"
echo "📊 覆盖率报告: htmlcov/index.html"
```

使用：
```bash
chmod +x run_quality_check.sh
./run_quality_check.sh
```

### 3. Git Pre-commit Hook

创建 `.git/hooks/pre-commit`：

```bash
#!/bin/bash

echo "🔍 执行pre-commit检查..."

# 只检查staged的Python文件
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -z "$STAGED_PY_FILES" ]; then
    echo "没有Python文件变更"
    exit 0
fi

# Pylint检查
echo "Pylint检查..."
pylint $STAGED_PY_FILES --fail-under=8.0 || exit 1

# 运行测试
echo "运行测试..."
pytest tests/ -v || exit 1

echo "✅ Pre-commit检查通过"
exit 0
```

启用：
```bash
chmod +x .git/hooks/pre-commit
```

---

## 🔗 参考资源

- [Pytest官方文档](https://docs.pytest.org/)
- [Coverage.py文档](https://coverage.readthedocs.io/)
- [Pylint文档](https://pylint.readthedocs.io/)
- [GitHub Actions文档](https://docs.github.com/en/actions)
- [质量门检查执行指南](./质量门检查执行指南.md)

---

**文档更新时间：** 2026-01-11
